<!doctype html>
<html lang=en>
<head>
  <meta charset=utf-8>
  <link href='http://fonts.googleapis.com/css?family=Cabin:bold' rel='stylesheet' type='text/css'>
  <title>Can Haz Parking?</title>
  <meta name="viewport" content="width=380px;" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link href="index.css" rel=stylesheet type=text/css>
  <link rel="apple-touch-icon" href="canpark.png" />
  <link rel="SHORTCUT ICON" href="canpark.ico" />
  <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/themes/smoothness/jquery-ui.css" rel=stylesheet type=text/css>
  <script type="text/javascript" src="js/CivicAPI.js"></script>
  <script type="text/javascript" src="js/GeoLoc.js"></script>
  <script type="text/javascript" src="js/Vehicle.js"></script>
  <script type="text/javascript" src="js/SnowRoute.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js"></script>
  <script type=text/javascript>

    function updateLoc(v) {
      $.ajax({
        url: "parking_spots",
        data: {
          "latitude": v.latitude,
          "longitude": v.longitude,
          "heading": v.heading.toString()
        },
        success: function(result) {
          $(".lefticon").addClass(result.left.flag);
          $(".righticon").addClass(result.right.flag);
          $("#streetsign").text(result.streetname);

          if (result.left.message) {
            $("#sidearrow").text(result.left.message);
          } else if (result.right.message) {
            $("#sidearrow").text(result.right.message);
          }
        },
        failure: function(result) {
          alert("aww, snap!");
        }
      });
    }

    function initVehicleFromAddress(address) {
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode( { 'address': address }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          if (results.length == 0) {
            return;
          }
          var position = {
            coords: {
              longitude: results[0].geometry.location.lng(),
              latitude: results[0].geometry.location.lat(),
              heading: 0
            }
          }
          var v = new Vehicle(position);
          updateLoc(v);
          isSnowEmergency(v, function() {
            $(".lefticon").addClass("snow");
            $(".righticon").addClass("snow");
          });
        }
      });
    }

    function getAddress() {
      $("#dialog-form").dialog({
        autoOpen: true,
        modal: true,
        buttons: {
          "Submit": function() {
            var a = $("#addressInput").val()
            initVehicleFromAddress(a);
            $(this).dialog("close");
          }
        }
      });
    }

    function cbFail(message) {
      alert(message);
    }

    $("#dialog-form").keyup(function(e) {
      if (e.keyCode == 13) {
        $("#dialog-form").dialog("close");
      }
    });

    $(document).ready(initVehicleFromGeoLocation(updateLoc, getAddress, cbFail));
  </script>
</head>
<body>
  <div id="dialog-form">
    <form>
      <fieldset>
        <label name="address" for="addressInput">Address</label>
        <input type="text" id="addressInput" class="text ui-widget-content ui-corner-all" />
      </fieldset>
    </form>
  </div>
  <div id="sidearrow"></div>
  <div class="centerline" id="one"></div>
  <div class="centerline" id="two"></div>
  <div id="parkinginfo"></div>
  <div class="icon lefticon"></div>
  <div class="icon righticon"></div>
  <div id="signcontainer">
    <span id="streetsign">Locating...</span>
    <div id="streetsignpost"></div>
  </div>
</body>
</html>

